---
title: "solubility_clustering"
author: "Alicia Key"
date: "1/24/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(dplyr)
library(readr)
library(gridExtra)
```

In my prior aqueous solubility regression study, I did an exploratory data visualization and found intriguing plots of solubility versus other variables in the study. I didn't perform any experimental modeling of those relationships in that study. Here, I followup by performing a cluster analysis of solubility relationships to help future regression modeling efforts. My question is: do clusters within each of these relationships explain each feature's effect on solubility?

``` {r}
df <- as_tibble(read.csv("data/delaney-processed.csv")) %>%
  select(
    compound = Compound.ID, 
    mw = Molecular.Weight, 
    h_bond_donors = Number.of.H.Bond.Donors, 
    rings = Number.of.Rings, 
    rotatable_bonds = Number.of.Rotatable.Bonds, 
    psa = Polar.Surface.Area, 
    solubility = measured.log.solubility.in.mols.per.litre
)
knitr::kable(head(df))
```

## Dataset description

See the previous post for a description of the dataset and variables I use in this study.

## Review of prior figures

Below are the plots of solubility versus other variables I want to explore with clustering. The plots have jittered points to prevent overplotting. 

``` {r, fig.height = 7, fig.width = 7, fig.cap = "Histograms and bar plots of variables"}
p1 <- ggplot(df, aes(x = mw)) +
  geom_histogram(bins = 10) +
  labs(title = "(a)") +
  theme_minimal()

p2 <- ggplot(df, aes(x = psa)) +
  geom_histogram(bins = 10) +
  labs(title = "(b)") +
  theme_minimal()

p3 <- ggplot(df, aes(x = solubility)) +
  geom_histogram(bins = 10) +
  labs(title = "(c)") +
  theme_minimal()

p4 <- ggplot(df, aes(x = h_bond_donors)) +
  geom_bar() +
  labs(title = "(d)") +
  theme_minimal()

p5 <- ggplot(df, aes(x = rings)) +
  geom_bar() +
  labs(title = "(e)") +
  theme_minimal()

p6 <- ggplot(df, aes(x = rotatable_bonds)) +
  geom_bar() +
  labs(title = "(f)") +
  theme_minimal()

grid.arrange(p1, p2, p3, p4, p5, p6, nrow = 3)
```

As shown above, the subplots (a), (b), (d), (e), and (f) show distributions that favor the low end of the distribution. This low-end favorability is essential when extracting relationships for values greater in these distributions. For example, data about what happens to solubility with large ring counts are relatively sparse.

Below are the plots of solubility versus other variables I will explore with clustering. The plots have jittered points to prevent overplotting.

``` {r, fig.height = 7, fig.width = 7, fig.cap = "Relationship of molecular weight to other variables"}
alpha = 0.1
p1 <- ggplot(df, aes(x = mw, y = solubility)) +
  geom_jitter(alpha = alpha, width = 0.1) +
  geom_smooth(method = "lm", se = FALSE) +
  labs(title = "(a)") +
  theme_minimal()

p2 <- ggplot(df, aes(x = psa, y = solubility)) +
  geom_jitter(alpha = alpha) +
  geom_smooth(method = "lm", se = FALSE) +
  labs(title = "(b)") +
  theme_minimal()

p3 <- ggplot(df, aes(x = h_bond_donors, y = solubility)) +
  geom_jitter(alpha = alpha, width = 0.1) +
  geom_smooth(method = "lm", se = FALSE) +
  labs(title = "(c)") +
  theme_minimal()

p4 <- ggplot(df, aes(x = rings, y = solubility)) +
  geom_jitter(alpha = alpha, width = 0.1) +
  geom_smooth(method = "lm", se = FALSE) +
  labs(title = "(d)") +
  theme_minimal()

p5 <- ggplot(df, aes(x = rotatable_bonds, y = solubility)) +
  geom_jitter(alpha = alpha, width = 0.1) +
  geom_smooth(method = "lm", se = FALSE) +
  labs(title = "(e)") +
  theme_minimal()

grid.arrange(p1, p2, p3, p4, p5, nrow = 3)
```

Each variable has a different trend of its effect on solubility, as shown above. Plots (b) (of polar surface area) and (c) (of h-bond donors) show increasing trends of solubility. Plots (a) (molecular weight), (d) (rings), and (e) (rotatable bonds) show decreasing trends in solubility.

## Solubility versus molecular weight

```{r}
hierarchical_clusters <- function(features_df) {
  cluster_labels = list()
  
  distances <- features_df %>%
    as.matrix() %>%
    scale() %>%
    dist()
  
  hclust_out <- hclust(distances, method = "complete")
  
  features_df %>%
    mutate(
      cluster_2 = as.factor(cutree(hclust_out, k = 2)),
      cluster_3 = as.factor(cutree(hclust_out, k = 3)),
      cluster_4 = as.factor(cutree(hclust_out, k = 4))
    )
}
```



```{r fig.height = 7, fig.width = 7}
mw_cluster_df <- hierarchical_clusters(select(df, solubility, mw))

cluster_2 <- ggplot(mw_cluster_df, aes(x = mw, y = solubility, col = cluster_2)) +
  geom_point(alpha = 0.25) +
  theme_minimal()

cluster_3 <- ggplot(mw_cluster_df, aes(x = mw, y = solubility, col = cluster_3)) +
  geom_point(alpha = 0.25) +
  theme_minimal()

cluster_4 <- ggplot(mw_cluster_df, aes(x = mw, y = solubility, col = cluster_4)) +
  geom_point(alpha = 0.25) +
  theme_minimal()

grid.arrange(cluster_2, cluster_3, cluster_4, nrow = 3)
```
