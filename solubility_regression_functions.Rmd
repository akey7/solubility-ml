---
title: "solubility_regression_functions"
author: "Alicia Key"
date: "1/10/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(readr)
library(dplyr)
library(tidyr)
library(broom)
library(ggplot2)
```

Read in the main dataframe and rename the columns

``` {r}
df <- as_tibble(read.csv("data/delaney-processed.csv")) %>%
  select(
    compound = Compound.ID, 
    mw = Molecular.Weight, 
    h_bond_donors = Number.of.H.Bond.Donors, 
    rings = Number.of.Rings, 
    rotatable_bonds = Number.of.Rotatable.Bonds, 
    psa = Polar.Surface.Area, 
    solubility = measured.log.solubility.in.mols.per.litre
)
```

Now define a few functions to run the analysis

``` {r}
solubilityTrainTestSplit <- function(all_data, split_fraction = 0.75, random_seed = 13) {
  # Shuffle based on random seed
  set.seed(random_seed)
  sample_indecies <- sample(nrow(all_data), nrow(all_data))
  shuffled <- all_data[sample_indecies, ]
  
  # Train test split
  train_row <- round(nrow(shuffled) * split)
  test_row <- train_row + 1
  train <- shuffled[1:train_row, ]
  test <- shuffled[test_row:nrow(shuffled), ]
  
  # Now pull off the compound names and make tibbles with only
  # the features.

  train_compounds <- train$compound
  test_compounds <- test$compound
  
  train_features <- train %>%
    select(-compound)
  
  test_features <- test %>%
    select(-compound)
  
  # Now create the final list that is returned
  list(
    train_features = train_features,
    test_features = test_features,
    train_compounds = train_compounds,
    test_compounds = test_compounds
  )
}

analyzeSolubilityModel <- function(model, test_features, test_compounds) {
  # Run the prediction
  predicted_solbilities <- predict(model, test_features)
  
  # Assemble the compounds and predictions back onto the
  # train features
  
  test_results <- test_features %>%
    mutate(prediction = test_predictions) %>%
    mutate(compound = test_compounds) %>%
    mutate(residual = solubility - prediction)
  
  # Calculate the standard deviation and RMSE
  sd_solubilities <- sd(test_results$solubility)
  rmse <- sqrt(mean(test_results$residual ^ 2))
  
  # Create a list to return to the caller
  list(
    sd_solubilities = sd_solubilities,
    rmse = rmse,
    test_results = test_results
  )
}
```
